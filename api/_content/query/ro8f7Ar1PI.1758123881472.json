{"_path":"/essay/10.gin-gorm2æ•°æ®åº“å‡†å¤‡","_dir":"essay","_draft":false,"_partial":false,"_locale":"","title":"2.gin-gormæ•°æ®åº“å‡†å¤‡","description":"é€šè¿‡gin-gormä¹‹é¡¹ç›®å­¦ä¹ éƒ¨åˆ†çš„å­¦ä¹ ï¼Œå¯ä»¥å¯¹é¡¹ç›®çš„æ¶æ„æœ‰æ·±å…¥çš„äº†è§£ ğŸ¤Ÿ\n{% post_link \"gin-gorm1é¡¹ç›®å‡†å¤‡åˆå§‹åŒ–\" %}\n{% post_link \"gin-gorm2æ•°æ®åº“\" %}\n{% post_link \"gin-gorm3é”™è¯¯å¤„ç†ä¸è·¯ç”±æ¥å£\" %}\n{% post_link \"gin-gorm4ç”¨æˆ·æ¨¡å—æ¥å£ç¼–å†™\" %}\n{% post_link \"gin-gorm5å¯†ç åŠ å¯†\" %}\n{% post_link \"gin-gorm6ç¼–è¾‘ã€åˆ é™¤ç”¨æˆ·\" %}","subtitle":"Database preparation","index":10,"date":"2023-02-13 00:00:02","lunar_date":"æ­£æœˆå»¿ä¸‰","year":"2023","month":"02","month_en":"Feb","day":"13","tag":"æŠ€æœ¯","tag_en":"TECH","cover":"/img/rabbit/010.jpg","categories":"gin-gormä¹‹é¡¹ç›®å­¦ä¹ ","body":{"type":"root","children":[{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"é€šè¿‡"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"gin-gormä¹‹é¡¹ç›®å­¦ä¹ "}]},{"type":"text","value":"éƒ¨åˆ†çš„å­¦ä¹ ï¼Œå¯ä»¥å¯¹é¡¹ç›®çš„æ¶æ„æœ‰æ·±å…¥çš„äº†è§£ ğŸ¤Ÿ\n{% post_link \"gin-gorm1é¡¹ç›®å‡†å¤‡åˆå§‹åŒ–\" %}"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n{% post_link \"gin-gorm2æ•°æ®åº“\" %}"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n{% post_link \"gin-gorm3é”™è¯¯å¤„ç†ä¸è·¯ç”±æ¥å£\" %}"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n{% post_link \"gin-gorm4ç”¨æˆ·æ¨¡å—æ¥å£ç¼–å†™\" %}"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n{% post_link \"gin-gorm5å¯†ç åŠ å¯†\" %}"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n{% post_link \"gin-gorm6ç¼–è¾‘ã€åˆ é™¤ç”¨æˆ·\" %}"},{"type":"element","tag":"br","props":{},"children":[]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h1","props":{"id":"å®‰è£…gorm"},"children":[{"type":"text","value":"å®‰è£…Gorm"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"å®‰è£…gorm  ç°åœ¨æ˜¯v2ç‰ˆæœ¬"}]},{"type":"element","tag":"pre","props":{"className":["language-bash"],"code":"go get -u gorm.io/gorm\n","language":"bash","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"go get -u gorm.io/gorm\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"æ³¨æ„é™¤äº†gormå¤–è¿˜éœ€è¦æœ‰æ•°æ®åº“é©±åŠ¨ï¼Œæœ¬äººä½¿ç”¨çš„æ˜¯postgresqlï¼Œä½¿ç”¨å…¶ä»–æ•°æ®åº“çš„è¯·å‚è€ƒå®˜ç½‘"}]},{"type":"element","tag":"pre","props":{"className":["language-go"],"code":"import \"gorm.io/driver/postgres\"\n","language":"go","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import \"gorm.io/driver/postgres\"\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ç„¶åæ ¹æ®æç¤ºå¯¼å…¥ï¼Œæˆ–è€…è¿è¡Œgo mod tidyï¼Œè¯¥å‘½ä»¤èƒ½å¤Ÿå¯¼å…¥æ‰€æœ‰ä¾èµ–çš„åº“å¹¶åˆ é™¤å¤šä½™çš„åº“"}]},{"type":"element","tag":"h1","props":{"id":"æ•°æ®æ¨¡å‹"},"children":[{"type":"text","value":"æ•°æ®æ¨¡å‹"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"åœ¨modelæ–‡ä»¶å¤¹ä¸‹å»ºç«‹æ•°æ®åº“å…¥å£æ–‡ä»¶ db.go"}]},{"type":"element","tag":"pre","props":{"className":["language-go"],"code":"// å…¨å±€å˜é‡ï¼Œdbå’Œerroråœ¨å…¶ä»–æ–‡ä»¶é‡Œä¹Ÿéœ€è¦ä½¿ç”¨\nvar (\n    db  *gorm.DB\n    err error\n)\nfunc InitDb() {\n    //ä½¿ç”¨å ä½ç¬¦ï¼Œç„¶åç”¨setting.goé‡Œçš„é…ç½®å‚æ•°æ¥æ›¿ä»£\n    dsn := fmt.Sprintf(\"host=%s user=%s password=%s dbname=%s port=%s sslmode=disable TimeZone=Asia/Shanghai\",\n        utils.DbHost,\n        utils.DbUser,\n        utils.DbPassword,\n        utils.DbName,\n        utils.DbPort,\n    )\n    db, err = gorm.Open(postgres.Open(dsn), &gorm.Config{\n        //ç¦ç”¨é»˜è®¤è¡¨åçš„å¤æ•°å½¢å¼\n        NamingStrategy: schema.NamingStrategy{SingularTable: true},\n    })\n    if err != nil {\n        fmt.Println(\"æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥å‚æ•°\", err)\n\n    }\n\n    //\n\n    //æ•°æ®åº“è‡ªåŠ¨è¿ç§»ï¼Œæ‹¬å·å†…çš„å‚æ•°ä¸ºéœ€è¦æ„å»ºçš„æ•°æ®æ¨¡å‹ç»“æ„ä½“\n    db.AutoMigrate()\n\n    sqlDB, err := db.DB()\n    if err != nil {\n        fmt.Println(\"æ•°æ®åº“è¿æ¥è®¾ç½®å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¿æ¥å‚æ•°\", err)\n    }\n    // SetMaxIdleConns è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­è¿æ¥çš„æœ€å¤§æ•°é‡\n    sqlDB.SetMaxIdleConns(10)\n\n    // SetMaxOpenConns è®¾ç½®æ‰“å¼€æ•°æ®åº“è¿æ¥çš„æœ€å¤§æ•°é‡ã€‚\n    sqlDB.SetMaxOpenConns(100)\n\n    // SetConnMaxLifetime è®¾ç½®äº†è¿æ¥å¯å¤ç”¨çš„æœ€å¤§æ—¶é—´ã€‚\n    //ä¸èƒ½è¶…è¿‡ gin æ¡†æ¶çš„è¿æ¥è¶…æ—¶æ—¶é—´\n    sqlDB.SetConnMaxLifetime(10 * time.Second)\n\n    //sqlDB.Close()\n}\n","language":"go","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// å…¨å±€å˜é‡ï¼Œdbå’Œerroråœ¨å…¶ä»–æ–‡ä»¶é‡Œä¹Ÿéœ€è¦ä½¿ç”¨\nvar (\n    db  *gorm.DB\n    err error\n)\nfunc InitDb() {\n    //ä½¿ç”¨å ä½ç¬¦ï¼Œç„¶åç”¨setting.goé‡Œçš„é…ç½®å‚æ•°æ¥æ›¿ä»£\n    dsn := fmt.Sprintf(\"host=%s user=%s password=%s dbname=%s port=%s sslmode=disable TimeZone=Asia/Shanghai\",\n        utils.DbHost,\n        utils.DbUser,\n        utils.DbPassword,\n        utils.DbName,\n        utils.DbPort,\n    )\n    db, err = gorm.Open(postgres.Open(dsn), &gorm.Config{\n        //ç¦ç”¨é»˜è®¤è¡¨åçš„å¤æ•°å½¢å¼\n        NamingStrategy: schema.NamingStrategy{SingularTable: true},\n    })\n    if err != nil {\n        fmt.Println(\"æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥å‚æ•°\", err)\n\n    }\n\n    //\n\n    //æ•°æ®åº“è‡ªåŠ¨è¿ç§»ï¼Œæ‹¬å·å†…çš„å‚æ•°ä¸ºéœ€è¦æ„å»ºçš„æ•°æ®æ¨¡å‹ç»“æ„ä½“\n    db.AutoMigrate()\n\n    sqlDB, err := db.DB()\n    if err != nil {\n        fmt.Println(\"æ•°æ®åº“è¿æ¥è®¾ç½®å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¿æ¥å‚æ•°\", err)\n    }\n    // SetMaxIdleConns è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­è¿æ¥çš„æœ€å¤§æ•°é‡\n    sqlDB.SetMaxIdleConns(10)\n\n    // SetMaxOpenConns è®¾ç½®æ‰“å¼€æ•°æ®åº“è¿æ¥çš„æœ€å¤§æ•°é‡ã€‚\n    sqlDB.SetMaxOpenConns(100)\n\n    // SetConnMaxLifetime è®¾ç½®äº†è¿æ¥å¯å¤ç”¨çš„æœ€å¤§æ—¶é—´ã€‚\n    //ä¸èƒ½è¶…è¿‡ gin æ¡†æ¶çš„è¿æ¥è¶…æ—¶æ—¶é—´\n    sqlDB.SetConnMaxLifetime(10 * time.Second)\n\n    //sqlDB.Close()\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"åœ¨modelæ–‡ä»¶å¤¹ä¸‹å»ºç«‹æ•°æ®æ¨¡å‹æ–‡ä»¶ User.go ã€Article.go ã€Category.go\nåˆ›å»ºç»“æ„ä½“"}]},{"type":"element","tag":"pre","props":{"className":["language-GO"],"code":"type User struct {\n    gorm.Model\n\n    Username string `gorm:\"type:varchar(20);not null \" json:\"username\"`\n    Password string `gorm:\"type:varchar(20);not null \" json:\"password\"`\n    Role     int    `gorm:\"type:int; \" json:\"role\"`\n}\n\ntype Category struct {\n    gorm.Model\n\n    Name string `gorm:\"type:varchar(20);not null \" json:\"name\"`\n}\n\ntype Article struct {\n    gorm.Model\n    Title       string   `gorm:\"type:varchar(20);not null\" json:\"title\"`\n    Category    Category \n    CategoryId  int      `gorm:\"type:int;not null\" json:\"category_id\"`\n    Description string   `gorm:\"type:varchar(200)\" json:\"description\"`\n    Content     string   `gorm:\"type:text\" json:\"content\"`\n    Img         string   `gorm:\"type:varchar(200)\" json:\"img\"`\n}\n","language":"GO","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"type User struct {\n    gorm.Model\n\n    Username string `gorm:\"type:varchar(20);not null \" json:\"username\"`\n    Password string `gorm:\"type:varchar(20);not null \" json:\"password\"`\n    Role     int    `gorm:\"type:int; \" json:\"role\"`\n}\n\ntype Category struct {\n    gorm.Model\n\n    Name string `gorm:\"type:varchar(20);not null \" json:\"name\"`\n}\n\ntype Article struct {\n    gorm.Model\n    Title       string   `gorm:\"type:varchar(20);not null\" json:\"title\"`\n    Category    Category \n    CategoryId  int      `gorm:\"type:int;not null\" json:\"category_id\"`\n    Description string   `gorm:\"type:varchar(200)\" json:\"description\"`\n    Content     string   `gorm:\"type:text\" json:\"content\"`\n    Img         string   `gorm:\"type:varchar(200)\" json:\"img\"`\n}\n"}]}]},{"type":"element","tag":"h1","props":{"id":"ç”¨æ•°æ®åº“è¿ç§»åˆ›å»ºæ•°æ®è¡¨"},"children":[{"type":"text","value":"ç”¨æ•°æ®åº“è¿ç§»åˆ›å»ºæ•°æ®è¡¨"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"å›åˆ°æ•°æ®åº“å…¥å£æ–‡ä»¶ db.goï¼Œä½¿ç”¨åˆ›å»ºçš„ç»“æ„ä½“"}]},{"type":"element","tag":"pre","props":{"className":["language-go"],"code":"//æ•°æ®åº“è‡ªåŠ¨è¿ç§»\n    db.AutoMigrate(&User{}, &Category{}, &Article{})\n","language":"go","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"//æ•°æ®åº“è‡ªåŠ¨è¿ç§»\n    db.AutoMigrate(&User{}, &Category{}, &Article{})\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"æœ€ååœ¨main.goä¸­ä½¿ç”¨æ•°æ®åº“åˆå§‹åŒ–å‡½æ•°InitDb()"}]},{"type":"element","tag":"pre","props":{"className":["language-go"],"code":"model.InitDb()\n","language":"go","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"model.InitDb()\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"è¿è¡Œé¡¹ç›®main.go,èƒ½å¤Ÿçœ‹åˆ°æ•°æ®åº“æ ¹æ®modelå»ºç«‹äº†æ•°æ®è¡¨ï¼Œæ•°æ®åº“è¿æ¥å·¥å…·åº“æœ¬äººä½¿ç”¨çš„æ˜¯DBeaver"}]}],"toc":{"title":"","searchDepth":2,"depth":3,"links":[]}},"_type":"markdown","_id":"content:essay:10.gin-gorm2æ•°æ®åº“å‡†å¤‡.md","_source":"content","_file":"essay/10.gin-gorm2æ•°æ®åº“å‡†å¤‡.md","_stem":"essay/10.gin-gorm2æ•°æ®åº“å‡†å¤‡","_extension":"md"}